<!DOCTYPE html>
<html>
  <head>
    <title>BokkyPooBah's Ether Vending Machine</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="BokkyPooBah's Ether Vending Machine (c) Bok Consulting Pty Ltd 2019">
    <meta name="author" content="BokkyPooBah/bokconsulting.com.au">
    <link href="css/bootstrap.css" rel="stylesheet" media="screen" />
    <link href="css/w2ui-1.5.rc1.css" rel="stylesheet" media="screen" />
    <link href="css/app.css" rel="stylesheet" media="screen" />
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/w2ui-1.5.rc1.js"></script>
    <script src="js/bignumber.min.js"></script>
    <script src="js/web3.js"></script>
    <script src="js/app.js"></script>

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="images/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="images/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="images/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="images/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="images/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="images/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="images/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="images/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="images/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="images/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="images/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="images/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="images/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="images/mstile-310x310.png" />

  </head>
  <body>
    <div class="navbar navbar-default" role="navigation">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <i class="icon-menu"></i> Menu
        </button>
        <a class="navbar-brand logo navbar-left" href="/"><img style="max-width:53px; margin-top: -16px;" src="images/Me-zoomed.png"></a>
        <a class="navbar-brand logo" href="/">Ether Vending Machine</a>
      </div>
      <div class="container">
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" title="Vending Machine Services">Services <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#"><strong>Deploy Your Own Fixed Supply Token Contract</strong> <span>(BokkyPooBah's Fixed Supply Token 👊 Factory v1.10)</span></a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" title="Vending Machine Contracts">Contracts <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="https://etherscan.io/address/0xA550114ee3688601006b8b9f25e64732eF774934#code"><strong>BokkyPooBah's Fixed Supply Token 👊 Factory v1.10</strong> <span>0xA550114e</span></a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" title="Help">Help <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#faq" target="_blank"><i class="icon-star fa-fw"></i> FAQ</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Development Details</li>
                <li class="divider"></li>
                <li><a href="https://github.com/bokkypoobah/EtherVendingMachine" target="_blank"><i class="icon-star fa-fw"></i> Ether Vending Machine</a></li>
                <li><a href="https://github.com/bokkypoobah/FixedSupplyTokenFactory" target="_blank"><i class="icon-star fa-fw"></i> BokkyPooBah's Fixed Supply Token 👊 Factory</a></li>
                <li class="divider"></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-8">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Deploy Your Own Fixed Supply Token Contract</h3>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="form-group col-xs-6">
                  <label for="symbol">Symbol</label>
                  <input type="text" class="form-control" id="symbol" aria-describedby="symbolHelp" placeholder="example 'BBC'">
                  <small id="symbolHelp" class="form-text text-muted">An uppercase word a few letters long</small>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-xs-9">
                  <label for="name">Name</label>
                  <input type="text" class="form-control" id="name" aria-describedby="nameHelp" placeholder="example 'Bob's Burgers 🍔 & Chips 🍟 Loyalty Points'">
                  <small id="nameHelp" class="form-text text-muted">A set of mixed case words</small>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-xs-6">
                  <label for="decimals">Decimals</label>
                  <input type="number" class="form-control" id="decimals" aria-describedby="decimalsHelp" placeholder="example '18'">
                  <small id="decimalsHelp" class="form-text text-muted">Number of decimal places, between 0 and 18, inclusive</small>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-xs-6">
                  <label for="totalSupply">Total Supply</label>
                  <input type="number" class="form-control" id="totalSupply" aria-describedby="totalSupplyHelp" placeholder="example '123456.789'">
                  <small id="totalSupplyHelp" class="form-text text-muted">A positive number less than or equals to 100,000,000,000,000</small>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-xs-5">
                  <label for="deploymentFee">Deployment Fee (in ethers)</label>
                  <input type="number" class="form-control" id="deploymentFee" aria-describedby="deploymentFeeHelp" placeholder="example 0.123456789">
                  <small id="deploymentFeeHelp" class="form-text text-muted">Minimum deployment fee 0.1 ethers</small>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-md-6">
                  <button type="submit" id="deploy" class="btn btn-primary" aria-describedby="deployHelp" disabled>
                    <span class="glyphicon glyphicon glyphicon-play"></span> Submit Transaction
                  </button>
                  <div class="clearfix"></div>
                  <small id="deployHelp" class="form-text text-muted"></small>
                </div>
                <div class="clearfix"></div>
                <div id="transactionStatusDiv" class="form-group col-xs-5 hidden">
                  <label for="transactionStatus">Transaction Status</label>
                  <p class="card-text" id="transactionStatus"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Activity</h3>
            </div>
            <div class="panel-body">
              <p class="card-text text-danger">You will need MetaMask in Firefox, Chromium, Brave and Chrome browser to use this vending machine, currently.</p>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Network &amp; Your Account</h3>
            </div>
            <div class="panel-body">
              <p class="panel-text">
                <span id="network" data-toggle="tooltip" title="Switch networks in MetaMask for the Ethereum Mainnet, or the Ropsten, Kovan, Rinkeby and Görli testnets">Checking ...</span>
                <span id="spinner" class="glyphicon glyphicon glyphicon-heart text-danger" aria-hidden="true" data-toggle="tooltip" title="The heartbeat of the blockchain">
                <span id="block" class="truncate" data-toggle="tooltip" title="The latest block number and time, and it should be recent"></span>
              </p>
              <p class="panel-text"><span id="account" data-toggle="tooltip" title="Your account in MetaMask"></span></p>
              <p class="panel-text">Balance <span id="accountbalance" data-toggle="tooltip" title="Your account balance"></span></p>
              <p class="panel-text truncate"><span id="faucets" data-toggle="tooltip" title="Get testnet ethers from the faucets"></span></p>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Factory</h3>
            </div>
            <div class="panel-body">
              <p class="panel-text"><span id="factoryAddress" class="truncate" data-toggle="tooltip" title="The factory that will deploy your token contract"></span></p>
              <p class="panel-text">Minimum fee <span id="minimumFee" data-toggle="tooltip" title="Minimum fee required to deploy your token contract"></p>
              <h6 class="panel-title">Deployed token contracts</h6>
              <div id="deployedContractsList"></div>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Donations</h3>
            </div>
            <div class="panel-body">
              <p class="panel-text"><a href="https://etherscan.io/address/0x000001f568875f378bf6d170b790967fe429c81a" target="_blank">0x000001f568875f378bf6d170b790967fe429c81a</a></span></p>
              <p class="panel-text">Enjoy! &copy; Bok Consulting Pty Ltd 2019</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
<script type="text/javascript">
// ----------------------------------------------------------------------------
// BokkyPooBah's Ether Vending Machine v0.90
//
// FixedSupplyTokenFactory deployment address
//   0xA550114ee3688601006b8b9f25e64732eF774934
//
// https://github.com/bokkypoobah/EtherVendingMachine
//
// TODO:
// * Handle non MetaMask gracefully
// * Data generation for offline/MEW/MyCrypto execution
// * Transaction reporting
// * Test out with geth and parity RPC
// * Test out with Mist
// * Nice to have - add Ledger and Trezor signing
//
// Enjoy. (c) BokkyPooBah / Bok Consulting Pty Ltd 2019. The MIT Licence.
// ----------------------------------------------------------------------------

// Network           Network Id   Chain Id
// Mainnet                    1          1
// Ropsten                    3          3
// Rinkeby                    4          4
// Kovan                     42         42
// Görli                      5          5
// Truffle Develop Network 4447
// Ganache Blockchain      5777
// Testnet   | Explorers                     | Testnet ETH Faucets
// :-------- |:----------------------------- |:-------------------------
// Ropsten   | https://ropsten.etherscan.io/ | https://faucet.metamask.io/<br />https://twitter.com/BokkyPooBah/status/1099498823699714048
// Kovan     | https://kovan.etherscan.io/   | https://faucet.kovan.network/<br />https://github.com/kovan-testnet/faucet<br />https://faucet.kovan.radarrelay.com/
// Rinkeby   | https://rinkeby.etherscan.io/ | https://faucet.metamask.io/<br />https://faucet.rinkeby.io/
// Görli     | https://goerli.etherscan.io/  | https://faucet.goerli.mudit.blog/<br />https://goerli-faucet.slock.it/<br />https://bridge.goerli.com/

var networks = {
  "-1"   : { "network": "(unknown)", "explorer": "(unknown)", "faucets": "(n/a)" },
  "1"    : { "network": "Ethereum Mainnet", "explorer": "https://etherscan.io/", "faucets": "" },
  "2"    : { "network": "Morden Testnet (deprecated)", "explorer": "https://morden.etherscan.io/", "faucets": "(deprecated)" },
  "3"    : { "network": "Ropsten Testnet", "explorer": "https://ropsten.etherscan.io/", "faucets": "Faucets: <a href=\"https://faucet.metamask.io/\" target=\"_blank\">faucet.metamask.io</a>, <a href=\"https://twitter.com/BokkyPooBah/status/1099498823699714048\" target=\"_blank\">BokkyPooBah's VIP</a>" },
  "4"    : { "network": "Rinkeby Testnet", "explorer": "https://rinkeby.etherscan.io/", "faucets": "Faucets: <a href=\"https://faucet.metamask.io/\" target=\"_blank\">faucet.metamask.io</a>, <a href=\"https://faucet.rinkeby.io/\" target=\"_blank\">faucet.rinkeby.io</a>" },
  "42"   : { "network": "Kovan Testnet", "explorer": "https://kovan.etherscan.io/", "faucets": "Faucets: <a href=\"https://faucet.kovan.network/\" target=\"_blank\">faucet.kovan.network</a>, <a href=\"https://github.com/kovan-testnet/faucet\" target=\"_blank\">github.com/kovan-testnet</a>" },
  "5"    : { "network": "Görli Testnet", "explorer": "https://goerli.etherscan.io/", "faucets": "<a href=\"https://faucet.goerli.mudit.blog/\" target=\"_blank\">https://faucet.goerli.mudit.blog/</a><br /><a href=\"https://goerli-faucet.slock.it/\" target=\"_blank\">https://goerli-faucet.slock.it/</a>" },
  "4447" : { "network": "Truffle Devnet", "explorer": "(none)", "faucets": "(n/a)" },
  "5777" : { "network": "Ganache Devnet", "explorer": "(none)", "faucets": "(n/a)" },
};

var factoryAddress = "0xA550114ee3688601006b8b9f25e64732eF774934";
var factoryAbi = [{"constant":false,"inputs":[{"name":"token","type":"address"},{"name":"tokens","type":"uint256"}],"name":"recoverTokens","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_minimumFee","type":"uint256"}],"name":"setMinimumFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"minimumFee","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"numberOfChildren","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"children","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"acceptOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"newAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"symbol","type":"string"},{"name":"name","type":"string"},{"name":"decimals","type":"uint8"},{"name":"totalSupply","type":"uint256"}],"name":"deployTokenContract","outputs":[{"name":"token","type":"address"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"newOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newAddress","type":"address"}],"name":"deprecateFactory","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"isChild","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_newAddress","type":"address"}],"name":"FactoryDeprecated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"oldFee","type":"uint256"},{"indexed":false,"name":"newFee","type":"uint256"}],"name":"MinimumFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"token","type":"address"},{"indexed":false,"name":"symbol","type":"string"},{"indexed":false,"name":"name","type":"string"},{"indexed":false,"name":"decimals","type":"uint8"},{"indexed":false,"name":"totalSupply","type":"uint256"}],"name":"TokenDeployed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"}],"name":"OwnershipTransferred","type":"event"}];
var tokenAbi = [{"constant":false,"inputs":[{"name":"token","type":"address"},{"name":"tokens","type":"uint256"}],"name":"recoverTokens","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"}],"name":"init","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"acceptOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"tokenOwner","type":"address"},{"name":"symbol","type":"string"},{"name":"name","type":"string"},{"name":"decimals","type":"uint8"},{"name":"fixedSupply","type":"uint256"}],"name":"init","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transfer","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"},{"name":"data","type":"bytes"}],"name":"approveAndCall","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"newOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"tokenOwner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Approval","type":"event"}];

var SYMBOLMAXLENGTH = 64;
var NAMEMAXLENGTH = 128;
var DECIMALSMAX = 18;
var TOTALSUPPLYMAX = new BigNumber("1").shift(14); // 100 trillion
var DEPLOYMENTFEEMAX = new BigNumber("100");

var DEFAULTDECIMALS = 18;
var DEFAULTTOTALSUPPLY = new BigNumber("1");

var MAXFACTORYCHILDREN = 5;

var SYMBOLNOTE = "An uppercase word a few letters long. Maximum length " + SYMBOLMAXLENGTH;
var NAMENOTE = "A set of mixed case words. Maximum length " + NAMEMAXLENGTH;
var DECIMALSNOTE = "Number of decimal places, between 0 and " + DECIMALSMAX + ", inclusive";
var TOTALSUPPLYNOTE = "A positive number less than or equals to " + w2utils.formatNumber(TOTALSUPPLYMAX.toString());
var DEPLOYMENTFEENOTE = "Minimum deployment fee ";
var READYTODEPLOY = "Note that there are additional network transaction fees"
var NETWORKERROR = "Network error. Please check you have MetaMask installed and enabled in your web browser";
var FACTORYSHORTNAME = "Fixed Supply Token 👊 Factory v1.10"
var FACTORYDEPLOYGAS = 1200000;

var lastNetworkId = -123;
var lastBlockNumber = -123;
var lastNumberOfChildren = new BigNumber(-123);
var LOOPPERIOD = 5000;
var loopCounter = 0;
var connectionOk = false;
var currentMinimumFee;


// ----------------------------------------------------------------------------
// Convenience function
// ----------------------------------------------------------------------------
const promisify = (inner) =>
  new Promise((resolve, reject) =>
    inner((err, res) => {
      if (err) {
        reject(err);
      } else {
        resolve(res);
      }
    })
  );


// ----------------------------------------------------------------------------
// Event listeners. Main process loop and individual fields
// ----------------------------------------------------------------------------
window.addEventListener('load', async () => {
  processLoop("refresh");
});
$('#deploy').on('click', function (e) {
  execute('deployClicked');
})
$('#symbol').on('change', function (e) {
  execute('symbolChanged');
})
$('#name').on('change', function (e) {
  execute('nameChanged');
})
$('#decimals').on('change', function (e) {
  execute('decimalsChanged');
})
$('#totalSupply').on('change', function (e) {
  execute('totalSupplyChanged');
})
$('#deploymentFee').on('change', function (e) {
  execute('deploymentFeeChanged');
})


async function processLoop(action) {
  process(action);
  loopCounter = parseInt(loopCounter) + 1;
  setTimeout(function() { processLoop("refresh") }, LOOPPERIOD);
}
async function process(action) {
  console.log(loopCounter + " [process." + action + "] connection: " + connectionOk);
  if (!connectionOk) {
    console.log(loopCounter + " [process." + action + "] calling establishConnection");
    await establishConnection();
    console.log(loopCounter + " [process." + action + "] called establishConnection");
  }
  if (connectionOk) {
    try {
      var data = getInputData();
      renderInputData(data);
      console.log(loopCounter + " [process." + action + "] data: " + JSON.stringify(data));
      processEth(data, 'refresh');
      console.log(loopCounter + " [process." + action + "] processEth completed");
    } catch (error) {
      console.log(loopCounter + " [process." + action + "] error: " + error);
    }
  } else {
    console.log(loopCounter + " [process." + action + "] connection: " + connectionOk + " - Skipping process");
    // BK TODO
    $("#network").html(NETWORKERROR);
  }

}


// ----------------------------------------------------------------------------
// Execute functions
// ----------------------------------------------------------------------------
var functionCounter = 0;
async function execute(action) {
  console.log(functionCounter + " [execute." + action + "] connection: " + connectionOk);
  if (!connectionOk) {
    console.log(loopCounter + " [execute." + action + "] calling establishConnection");
    await establishConnection();
    console.log(loopCounter + " [execute." + action + "] called establishConnection");
  }
  if (connectionOk) {
    try {
      var data = getInputData(false);
      renderInputData(data);
      // Retry in case we running during a ETH refresh process
      while (!processEth(data, action)) {
        ;
      }
    } catch (error) {
      console.log(functionCounter + " [execute." + action + "] error: " + error);
    }
  } else {
    console.log(functionCounter + " [execute." + action + "] connection: " + connectionOk + " - Skipping processing");
  }
  functionCounter = parseInt(functionCounter) + 1;
}


// ----------------------------------------------------------------------------
// Try to establish a web3 connection
// ----------------------------------------------------------------------------
async function establishConnection() {
  console.log(loopCounter + " [establishConnection] connection: " + connectionOk);

  // Modern dapp browsers...
  if (window.ethereum) {
    window.web3 = new Web3(ethereum);
    try {
      // Request account access if needed
      await ethereum.enable();
      console.log(loopCounter + " [establishConnection] await ethereum.enable() completed");
      // Accounts now exposed
      connectionOk = true;
    } catch (error) {
      // User denied account access...
    }
  // Legacy dapp browsers...
  } else if (window.web3) {
    try {
      window.web3 = new Web3(web3.currentProvider);
      // Acccounts always exposed
      console.log(loopCounter + " [establishConnection] Legacy dapp browsers completed");
      connectionOk = true;
    } catch (error) {
    }
  // Non-dapp browsers...
  } else {
    try {
      window.web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
      console.log(loopCounter + " [establishConnection] Web3 connection");
      connectionOk = true;
    } catch (error) {
    }
  }
}


// ----------------------------------------------------------------------------
// Get input data from the web page and do some basic checking
// ----------------------------------------------------------------------------
function getInputData() {
  var data = {
    "inputFilled": true,
    "inputError": false,
    "symbol": "",
    "symbolError": false,
    "name": "",
    "nameError": false,
    "decimals": "",
    "decimalsValue": 0,
    "decimalsError": false,
    "totalSupply": "",
    "totalSupplyValue": 0,
    "totalSupplyError": false,
    "deploymentFee": "",
    "deploymentFeeValue": 0,
    "deploymentFeeError": false,
  };

  data.symbol = $('#symbol').val().trim();
  if (data.symbol.length == 0) {
    data.inputFilled = false;
  } else {
    if (data.symbol.length > SYMBOLMAXLENGTH) {
      data.inputError = true;
      data.symbolError = true;
    }
  }

  data.name = $('#name').val().trim();
  if (data.name.length == 0) {
    data.inputFilled = false;
  } else {
    if (data.name.length > NAMEMAXLENGTH) {
      data.inputError = true;
      data.nameError = true;
    }
  }

  data.decimals = $('#decimals').val();
  if (data.decimals.length == 0) {
    data.inputFilled = false;
  } else {
    try {
      data.decimalsValue = parseInt(data.decimals);
      if (isNaN(data.decimalsValue)) {
        throw "nan";
      }
      if (data.decimalsValue < 0 || data.decimalsValue > DECIMALSMAX) {
        throw "out of range";
      }
    } catch (e) {
      console.log(loopCounter + " [getInputData] decimals: " + e);
      data.decimalsValue = DEFAULTDECIMALS;
      data.decimalsError = true;
    }
  }
  if (data.decimalsError) {
    data.inputError = true;
  }

  data.totalSupply = $('#totalSupply').val();
  if (data.totalSupply.length == 0) {
    data.inputFilled = false;
  } else {
    try {
      if (data.inputFilled && !data.decimalsError) {
        var totalSupplyWithoutCommas = data.totalSupply.replace(/\,/g, '');
        data.totalSupplyValue = new BigNumber(totalSupplyWithoutCommas);
        console.log(loopCounter + " [getInputData] totalSupply: " + data.totalSupply);
        console.log(loopCounter + " [getInputData] totalSupplyValue: " + data.totalSupplyValue);
        console.log(loopCounter + " [getInputData] data.totalSupplyValue.shift(data.decimals): " + data.totalSupplyValue.shift(data.decimals));
        console.log(loopCounter + " [getInputData] data.totalSupplyValue.shift(data.decimals).lessThan(1): " + data.totalSupplyValue.shift(data.decimals).lessThan(1));
        console.log(loopCounter + " [getInputData] data.totalSupplyValue > TOTALSUPPLYMAX: " + (data.totalSupplyValue.gt(TOTALSUPPLYMAX)));
        if (isNaN(data.totalSupplyValue)) {
          throw "nan";
        }
        if (data.totalSupplyValue.shift(data.decimals).lessThan(1) || data.totalSupplyValue.gt(TOTALSUPPLYMAX)) {
          throw "out of range";
        }
      }
    } catch (e) {
      console.log(loopCounter + " [getInputData] totalSupply: " + e);
      data.totalSupplyValue = DEFAULTTOTALSUPPLY;
      data.totalSupplyError = true;
    }
  }
  if (data.totalSupplyError) {
    data.inputError = true;
  }

  data.deploymentFee = $('#deploymentFee').val();
  if (data.deploymentFee.length == 0) {
    data.inputFilled = false;
  } else {
    try {
      var v = data.deploymentFee;
      if (v.startsWith(".")) {
        v = "0" + v;
      }
      data.deploymentFeeValue = new BigNumber(v);
      if (isNaN(data.deploymentFeeValue)) {
        throw "nan";
      }
      if (data.deploymentFee < currentMinimumFee || data.deploymentFee > DEPLOYMENTFEEMAX) {
        throw "out of range";
      }
    } catch (e) {
      console.log(loopCounter + " [getInputData] deploymentFee: " + e);
      data.deploymentFeeValue = currentMinimumFee;
      data.deploymentFeeError = true;
    }
  }
  if (data.deploymentFeeError) {
    data.inputError = true;
  }

  return data;
}


// ----------------------------------------------------------------------------
// Render any input data warnings
// ----------------------------------------------------------------------------
function renderInputData(data) {
  if (data.symbolError) {
    $("#symbolHelp").removeClass("text-muted").addClass("text-danger");
  } else {
    $("#symbolHelp").removeClass("text-danger").addClass("text-muted");
  }
  $("#symbolHelp").html(SYMBOLNOTE);

  if (data.nameError) {
    $("#nameHelp").removeClass("text-muted").addClass("text-danger");
  } else {
    $("#nameHelp").removeClass("text-danger").addClass("text-muted");
  }
  $("#nameHelp").html(NAMENOTE);

  if (data.decimalsError) {
    $("#decimalsHelp").removeClass("text-muted").addClass("text-danger");
  } else {
    $("#decimalsHelp").removeClass("text-danger").addClass("text-muted");
  }
  $("#decimalsHelp").html(DECIMALSNOTE);

  if (data.totalSupplyError) {
    $("#totalSupplyHelp").removeClass("text-muted").addClass("text-danger");
  } else {
    $("#totalSupplyHelp").removeClass("text-danger").addClass("text-muted");
  }
  $("#totalSupplyHelp").html(TOTALSUPPLYNOTE);
}


var spinner = 0;
var renderingEthData = false;
// ----------------------------------------------------------------------------
// Get ETH data, display, execute transaction if necessary
// ----------------------------------------------------------------------------
async function processEth(data, action) {
  var processed = false;
  if (!renderingEthData) {
    renderingEthData = true;

    if (data.inputFilled && !data.inputError) {
      $("#deploy").prop("disabled", false);
    } else {
      $("#deploy").prop("disabled", true);
    }

    var _networkId = promisify(cb => web3.version.getNetwork(cb));
    var _block = promisify(cb => web3.eth.getBlock("latest", cb));
    var _accounts = promisify(cb => web3.eth.getAccounts(cb));
    var networkId = -1;
    var seen = {};
    try {
      networkId = await _networkId;
      var networkChanged = false;
      if (lastNetworkId != networkId) {
        networkChanged = true;
        lastNetworkId = networkId;
      }
      var network = networks[networkId];
      if (network == null) {
        network = networks[-1];
      }
      $("#network").html("<a href=\"" + network.explorer + "\" target=\"_blank\">" + network.network + "</a>");
      $("#faucets").html(network.faucets);
      $("#factoryAddress").html('<a href="'+ network.explorer + 'address/' + factoryAddress + '#code" target="_blank">' + FACTORYSHORTNAME + ' ' + factoryAddress + '</a>');

      var block = await _block;
      var blockNumber = block.number;
      if (blockNumber != lastBlockNumber) {
        spinner = parseInt(spinner) + 1;
        if ((spinner % 2) == 0) {
          $("#spinner").removeClass("glyphicon-heart").addClass("glyphicon-heart-empty");
        } else {
          $("#spinner").removeClass("glyphicon-heart-empty").addClass("glyphicon-heart");
        }
        lastBlockNumber = blockNumber;
      }
      var timestamp = block.timestamp;
      // var now = new Date() / 1000;
      // var diff = timestamp - now;
      // $("#blockTime").html(diff.toFixed(2) + " seconds " + new Date(timestamp * 1000).toUTCString());
      // $("#blockTime").html(w2utils.formatTime(timestamp * 1000, 'hh24:mi:ss'));
      $("#block").html('<a href="'+ network.explorer + 'block/' + blockNumber + '" target="_blank">' + w2utils.formatNumber(blockNumber) + ' ' + w2utils.formatTime(timestamp * 1000, 'hh24:mi:ss') + ' ' + w2utils.formatDate(timestamp * 1000, 'mon dd') + '</a>');

      var accounts = await _accounts;
      var account = accounts[0];
      $("#account").html('<a href="' + network.explorer + 'address/' + account + '#code" target="_blank">' + account + '</a>');

      var _balance = promisify(cb => web3.eth.getBalance(account, cb));
      var balance = new BigNumber(await _balance).shift(-18);
      $("#accountbalance").html('<a href="' + network.explorer + 'address/' + account + '#code" target="_blank">' + balance.toString() + '</a> ethers');

      var factory = web3.eth.contract(factoryAbi).at(factoryAddress);
      var _minimumFee = promisify(cb => factory.minimumFee(cb));
      var minimumFee = new BigNumber(await _minimumFee).shift(-18);
      currentMinimumFee = minimumFee;
      $("#minimumFee").html('<a href="'+ network.explorer + 'address/' + factoryAddress + '#readContract" target="_blank">' + minimumFee.toString() + '</a> ethers');

      console.log(loopCounter + " [processEth] connectionOk: " + connectionOk + " deploymentFee: " + data.deploymentFeeValue + " minimumFee: " + minimumFee);
      if (data.deploymentFee.length > 0 && data.deploymentFeeValue < minimumFee) {
        console.log(loopCounter + " [processEth] connectionOk: " + connectionOk + " deploymentFee: " + data.deploymentFeeValue + " minimumFee: " + minimumFee + " insufficient fee");
        data.deploymentFeeError = true;
        data.inputError = true;
      }
      if (data.deploymentFeeError) {
        $("#deploymentFeeHelp").removeClass("text-muted").addClass("text-danger");
      } else {
        $("#deploymentFeeHelp").removeClass("text-danger").addClass("text-muted");
      }
      $("#deploymentFeeHelp").html(DEPLOYMENTFEENOTE + minimumFee + " ethers");

      if (data.inputError) {
        $("#deployHelp").removeClass("text-muted").addClass("text-danger");
        $("#deployHelp").html("Please correct errors in the field(s) above")
      } else if (!data.inputFilled) {
        $("#deployHelp").removeClass("text-danger").addClass("text-muted");
        $("#deployHelp").html("Please fill in the fields above");
      } else {
        $("#deployHelp").removeClass("text-danger").addClass("text-muted");
        $("#deployHelp").html(READYTODEPLOY);
      }
      if (data.inputFilled && !data.inputError) {
        $("#deploy").prop("disabled", false);
      } else {
        $("#deploy").prop("disabled", true);
      }

      var _numberOfChildren = promisify(cb => factory.numberOfChildren(cb));
      var numberOfChildren = new BigNumber(await _numberOfChildren);
      var factoryUpdated = false;
      if (!lastNumberOfChildren.equals(numberOfChildren)) {
        console.log(loopCounter + " [processEth] " + action + ": lastNumberOfChildren: " + lastNumberOfChildren + ", numberOfChildren: " + numberOfChildren);
        factoryUpdated = true;
        lastNumberOfChildren = numberOfChildren;
      }
      console.log(loopCounter + " [processEth] " + action + ": networkChanged: " + networkChanged + ", factoryUpdated: " + factoryUpdated);
      if (networkChanged || factoryUpdated) {
        var deployedContractsList = $('#deployedContractsList');
        var child = numberOfChildren - 1;
        var contentString = "";
        while (child >= 0 && child >= (numberOfChildren - MAXFACTORYCHILDREN)) {
          var _childAddress = promisify(cb => factory.children(child, cb));
          var childAddress = await _childAddress;
          var token = web3.eth.contract(tokenAbi).at(childAddress);
          var _symbol = promisify(cb => token.symbol(cb));
          var _name = promisify(cb => token.name(cb));
          var _decimals = promisify(cb => token.decimals(cb));
          var _totalSupply = promisify(cb => token.totalSupply(cb));
          var symbol = await _symbol;
          var name = await _name;
          var decimals = await _decimals;
          var totalSupply = await _totalSupply;
          if (!(childAddress in seen)) {
            var totalSupplyWithDecimals = new BigNumber(totalSupply).shift(-decimals);
            contentString += "<p class=\"truncate\">" + (parseInt(child) + 1) + ". <a href=\"" + network.explorer + "token/" + childAddress + "\">'" + symbol + "' '" + name + "' " + decimals + " " + w2utils.formatNumber(parseFloat(totalSupplyWithDecimals)) + " " + childAddress + "</a></p>";
            deployedContractsList.html(contentString);
            seen[childAddress] = true;
          }
          child--;
        }
      }

      if (data.inputFilled && !data.inputError && action == "deployClicked") {
        $("#deploy").prop("disabled", true);
        $("#transactionStatusDiv").removeClass("hidden");
        // $("#deployNote").html('Deploying token contract with deployment fee: ' + data.deploymentFeeValue.shift(-18).value);
        console.log("deploy balance: " + JSON.stringify(balance));
        console.log("deploy data.deploymentFee: " + JSON.stringify(data.deploymentFeeValue.shift(-18)));
        console.log("deploy minimumFee: " + JSON.stringify(minimumFee));
        if ((balance.greaterThanOrEqualTo(data.deploymentFeeValue)) && (data.deploymentFeeValue.greaterThanOrEqualTo(minimumFee))) {
          console.log("deployTokenContract: symbol: " + data.symbol);
          console.log("deployTokenContract: name: " + data.name);
          console.log("deployTokenContract: decimals: " + data.decimalsValue);
          console.log("deployTokenContract: totalSupply: " + data.totalSupplyValue.shift(data.decimals));
          console.log("deployTokenContract: account: " + account);
          console.log("deployTokenContract: gas: " + FACTORYDEPLOYGAS);
          console.log("deployTokenContract: data.deploymentFee: " + data.deploymentFeeValue);
          console.log("deployTokenContract: executing: factory.deployTokenContract(" + data.symbol + ", " + data.name + ", " + data.decimalsValue + ", " + data.totalSupplyValue.shift(data.decimals).toString() + ", {from: " + account + ", gas: " + FACTORYDEPLOYGAS + ", value: " + data.deploymentFeeValue.shift(18).toString() + "})");

          var txData = factory.deployTokenContract.getData(data.symbol, data.name, data.decimals, data.totalSupplyValue.shift(data.decimalsValue).toString(), {from: account, gas: FACTORYDEPLOYGAS, value: data.deploymentFeeValue.shift(18).toString()});
          console.log(JSON.stringify(txData));

          // function deployTokenContract(string memory symbol, string memory name, uint8 decimals, uint totalSupply) public payable returns (FixedSupplyToken token);
          factory.deployTokenContract(data.symbol, data.name, data.decimals, data.totalSupplyValue.shift(data.decimalsValue).toString(), {from: account, gas: FACTORYDEPLOYGAS, value: data.deploymentFeeValue.shift(18).toString()}, function(error, tx) {
            if (!error) {
              $("#deployNote").html('Deployed ' + tx + ' <a href="' + network.explorer + 'tx/' + tx + '" target="_blank">🔗</a>');
            } else {
              console.log("deployTokenContract error: " + error);
              $("#deployNote").html('Deployment ' + error);
              $("#deploy").prop("disabled", true);
            }
          });
        } else {
          $("#deployNote").html('Insufficient funds in your account ' + balance + ' ethers to pay the minimum fee of ' + minimumFee + " ethers");
        }
      }

    } catch (error) {
      var errorString = "";
      for (var key in error) {
        errorString += "{" + key + ": " + error[key] + "}";
      }
      $("#network").html(errorString);
    }
    processed = true;
    renderingEthData = false;
  }
  return processed;
}

</script>
  </body>
</html>
