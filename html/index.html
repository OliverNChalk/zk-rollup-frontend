<!DOCTYPE html>
<html>
  <head>
    <title>BokkyPooBah's Ether Vending Machine</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="BokkyPooBah's Ether Vending Machine (c) Bok Consulting Pty Ltd 2019">
    <meta name="author" content="BokkyPooBah/bokconsulting.com.au">
    <link href="css/bootstrap.css" rel="stylesheet" media="screen" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" media="screen" />
    <link href="css/app.css" rel="stylesheet" media="screen" />
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bignumber.min.js"></script>
    <script src="js/web3.js"></script>
    <script src="js/app.js"></script>
    <!-- <script src="js/preHFBalances.js"></script> -->

    <link rel="apple-touch-icon" sizes="57x57" href="images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
  <body>
    <!-- <canvas id="c"></canvas> -->
    <div class="navbar navbar-default" role="navigation">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <i class="icon-menu"></i> Menu
        </button>
        <a class="navbar-brand logo" href="/">BokkyPooBah's Ether Vending Machine</a>
      </div>
      <div class="container">
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" title="Vending Machine Services">Services <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#"><strong>Deploy Fixed Supply Token Contract</strong> <span>(BokkyPooBah's Fixed Supply Token ðŸ‘Š Factory v1.10)</span></a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" title="Vending Machine Contracts">Contracts <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="https://etherscan.io/address/0xA550114ee3688601006b8b9f25e64732eF774934#code"><strong>BokkyPooBah's Fixed Supply Token ðŸ‘Š Factory v1.10</strong> <span>0xA550114e</span></a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" title="Help">Help <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#faq" target="_blank"><i class="icon-star fa-fw"></i> FAQ</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Development Details</li>
                <li class="divider"></li>
                <li><a href="https://github.com/bokkypoobah/EtherVendingMachine" target="_blank"><i class="icon-star fa-fw"></i> Ether Vending Machine</a></li>
                <li><a href="https://github.com/bokkypoobah/FixedSupplyTokenFactory" target="_blank"><i class="icon-star fa-fw"></i> BokkyPooBah's Fixed Supply Token ðŸ‘Š Factory</a></li>
                <li class="divider"></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- <h4 class="display-3">Your Ethereum Address</h4> -->
      <form class="form-inline" method="GET">
        <!-- <div class="form-group"> -->
        <div class="row">
          <div class="col-sm-3 text-right">Status:</div>
          <div class="col-sm-8"><span id="status">This page is still under development</span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Network:</div>
          <div class="col-sm-8"><span id="network">Checking ...</span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Latest block number:</div>
          <div class="col-sm-8"><span id="blockNumber"></span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Latest block time:</div>
          <div class="col-sm-8"><span id="blockTime"></span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Your account:</div>
          <div class="col-sm-8"><span id="account"></span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Your account balance:</div>
          <div class="col-sm-8"><span id="accountbalance"></span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Faucets:</div>
          <div class="col-sm-8"><span id="faucets"></span></div>
        </div>
        <!--
        <div class="row">
          <div class="col-sm-3 text-right">Mode:</div>
          <div class="col-sm-3"><span id="mode">(unknown))</span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right"><b>Enter Your Ethereum Address:</b></div>
          <div class="col-sm-8"><input type="text" class="form-control" id="address" name="address" placeholder="0x..." size="48"><button type="submit" class="btn btn-default">Check</button></div>
        </div>
        -->
        <!-- </div> -->

        <br />

        <h4 class="display-3">BokkyPooBah's Fixed Supply Token ðŸ‘Š Factory v1.10</h4>
        <div class="row">
          <div class="col-sm-3 text-right">Address:</div>
          <div class="col-sm-8"><span id="factoryAddress"></span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Minimum fee:</div>
          <div class="col-sm-8"><span id="minimumFee"></span></div>
        </div>
        <div class="row">
          <div class="col-sm-3 text-right">Deployed token contracts:</div>
          <div class="col-sm-8"><span id="deployedContracts"><ul id="deployedContractsList"></ul></span></div>
        </div>

        <br />

        <h4 class="display-3">Your New Token Contract Details</h4>
        <div class="row" id="symbolDiv">
          <div class="col-sm-3 text-right">Symbol:</div>
          <div class="col-sm-3"><input type="text" class="form-control" id="symbol" name="symbol" placeholder="e.g. 'BEANIE'" size="12"></div>
          <span class="help-block" id="symbolNote"></span>
        </div>
        <div class="row has-error" id="nameDiv">
          <div class="col-sm-3 text-right">Name:</div>
          <div class="col-sm-3"><input type="text" class="form-control" id="name" name="name" placeholder="e.g. 'Beanie Things'" size="36"></div>
          <span class="help-block" id="nameNote"></span>
        </div>
        <div class="row has-error" id="decimalsDiv">
          <div class="col-sm-3 text-right">Decimals:</div>
          <div class="col-sm-3"><input type="text" class="form-control" id="decimals" name="decimals" placeholder="0..18" size="5"></div>
          <span class="help-block" id="decimalsNote"></span>
        </div>
        <div class="row has-error" id="totalSupplyDiv">
          <div class="col-sm-3 text-right">Total Supply:</div>
          <div class="col-sm-3"><input type="text" class="form-control" id="totalSupply" name="totalSupply" placeholder=">0 and <= 1 trillion" size="27"></div>
          <span class="help-block" id="totalSupplyNote"></span>
        </div>
        <div class="row has-error" id="deploymentFeeDiv">
          <div class="col-sm-3 text-right">Deployment Fee:</div>
          <div class="col-sm-3"><input type="text" class="form-control" id="deploymentFee" name="deploymentFee" placeholder="minimum 0.1 ethers" size="27"></div>
          <span class="help-block" id="deploymentFeeNote"></span>
        </div>
        <!-- <div class="row">
          <div class="col-sm-3 text-right">&nbsp</div>
          <div class="col-sm-3"><button type="button" class="btn btn-default" name="check" id="check">Check</button></div>
        </div> -->
        <div class="row">
          <div class="col-sm-3 text-right">&nbsp</div>
          <div class="col-sm-3"><button type="button" class="btn btn-default" name="deploy" id="deploy" disabled>Deploy</button></div>
          <span class="help-block" id="deployNote"></span>
        </div>
        <!-- <div class="row">
          <div class="col-sm-3 text-right">&nbsp</div>
          <div class="col-sm-3"><button type="button" class="btn btn-default" name="doIt" id="doIt">Do It</button></div>
          <span class="help-block" id="doItNote"></span>
        </div> -->
      </form>


      <br />

      <br />
      <!-- <p>URL <span id="url">{url}</span></p> -->
      <!-- <p>Address <span id="address1">{address1}</span></p> -->
      <!-- <p>Mode <span id="mode">{mode}</span></p> -->
      <!-- <p>Block Number <span id="blockNumber">{blockNumber}</span></p> -->
      <br />
      <br />

      <p>Switch networks in MetaMask.</p>
      <p>See <a href="https://etherscan.io/tokens" target="_blank">https://etherscan.io/tokens</a> for list of tokens on the Ethereum Mainnet.</p>
      <br />
      <br />
      <br />
      <br />
      <br />
      <br />
      <br />
      <br />
      <p>Enjoy! &copy; Bok Consulting Pty Ltd 2019 â€¢ Help fund the cost of running this site by donating to <a href="https://etherscan.io/address/0x000001f568875f378bf6d170b790967fe429c81a" target="_blank">0x000001f568875f378bf6d170b790967fe429c81a</a>.</p>
    </div>
<script type="text/javascript">
// ----------------------------------------------------------------------------
// BokkyPooBah's Ether Vending Machine v0.90
//
// FixedSupplyTokenFactory deployment address
//   0xA550114ee3688601006b8b9f25e64732eF774934
//
// https://github.com/bokkypoobah/EtherVendingMachine
//
// Enjoy. (c) BokkyPooBah / Bok Consulting Pty Ltd 2019. The MIT Licence.
// ----------------------------------------------------------------------------

// Network    Network Id   Chain Id
// Mainnet             1          1
// Ropsten             3          3
// Rinkeby             4          4
// Kovan              42         42
// GÃ¶rli               5          5
// Testnet   | Explorers                     | Testnet ETH Faucets
// :-------- |:----------------------------- |:-------------------------
// Ropsten   | https://ropsten.etherscan.io/ | https://faucet.metamask.io/<br />https://twitter.com/BokkyPooBah/status/1099498823699714048
// Kovan     | https://kovan.etherscan.io/   | https://faucet.kovan.network/<br />https://github.com/kovan-testnet/faucet<br />https://faucet.kovan.radarrelay.com/
// Rinkeby   | https://rinkeby.etherscan.io/ | https://faucet.metamask.io/<br />https://faucet.rinkeby.io/
// GÃ¶rli     | https://goerli.etherscan.io/  | https://faucet.goerli.mudit.blog/<br />https://goerli-faucet.slock.it/<br />https://bridge.goerli.com/

var networks = {
  "-1" : { "network": "(unknown)", "explorer": "(unknown)", "faucets": "(unknown)" },
  "1"  : { "network": "Ethereum Mainnet", "explorer": "https://etherscan.io/", "faucets": "No faucets on Mainnet" },
  "2"  : { "network": "Morden Testnet (deprecated)", "explorer": "https://morden.etherscan.io/", "faucets": "(deprecated)" },
  "3"  : { "network": "Ropsten Testnet", "explorer": "https://ropsten.etherscan.io/", "faucets": "<a href=\"https://faucet.metamask.io/\" target=\"_blank\">https://faucet.metamask.io/</a><br /><a href=\"https://twitter.com/BokkyPooBah/status/1099498823699714048\" target=\"_blank\">https://twitter.com/BokkyPooBah/status/1099498823699714048</a>" },
  "4"  : { "network": "Rinkeby Testnet", "explorer": "https://rinkeby.etherscan.io/", "faucets": "<a href=\"https://faucet.metamask.io/\" target=\"_blank\">https://faucet.metamask.io/</a><br /><a href=\"https://faucet.rinkeby.io/\" target=\"_blank\">https://faucet.rinkeby.io/</a>" },
  "42" : { "network": "Kovan Testnet", "explorer": "https://kovan.etherscan.io/", "faucets": "<a href=\"https://faucet.kovan.network/\" target=\"_blank\">https://faucet.kovan.network/</a><br /><a href=\"https://github.com/kovan-testnet/faucet\" target=\"_blank\">https://github.com/kovan-testnet/faucet</a>" },
  "5"  : { "network": "GÃ¶rli Testnet", "explorer": "https://goerli.etherscan.io/", "faucets": "<a href=\"https://faucet.goerli.mudit.blog/\" target=\"_blank\">https://faucet.goerli.mudit.blog/</a><br /><a href=\"https://goerli-faucet.slock.it/\" target=\"_blank\">https://goerli-faucet.slock.it/</a>" },
};

var factoryAddress = "0xA550114ee3688601006b8b9f25e64732eF774934";
var factoryAbi = [{"constant":false,"inputs":[{"name":"token","type":"address"},{"name":"tokens","type":"uint256"}],"name":"recoverTokens","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_minimumFee","type":"uint256"}],"name":"setMinimumFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"minimumFee","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"numberOfChildren","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"children","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"acceptOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"newAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"symbol","type":"string"},{"name":"name","type":"string"},{"name":"decimals","type":"uint8"},{"name":"totalSupply","type":"uint256"}],"name":"deployTokenContract","outputs":[{"name":"token","type":"address"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"newOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newAddress","type":"address"}],"name":"deprecateFactory","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"isChild","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_newAddress","type":"address"}],"name":"FactoryDeprecated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"oldFee","type":"uint256"},{"indexed":false,"name":"newFee","type":"uint256"}],"name":"MinimumFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"token","type":"address"},{"indexed":false,"name":"symbol","type":"string"},{"indexed":false,"name":"name","type":"string"},{"indexed":false,"name":"decimals","type":"uint8"},{"indexed":false,"name":"totalSupply","type":"uint256"}],"name":"TokenDeployed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"}],"name":"OwnershipTransferred","type":"event"}];
var tokenAbi = [{"constant":false,"inputs":[{"name":"token","type":"address"},{"name":"tokens","type":"uint256"}],"name":"recoverTokens","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"}],"name":"init","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"acceptOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"tokenOwner","type":"address"},{"name":"symbol","type":"string"},{"name":"name","type":"string"},{"name":"decimals","type":"uint8"},{"name":"fixedSupply","type":"uint256"}],"name":"init","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transfer","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"},{"name":"data","type":"bytes"}],"name":"approveAndCall","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"newOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"tokenOwner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Approval","type":"event"}];

var SYMBOLMAXLENGTH = 64;
var NAMEMAXLENGTH = 128;
var DECIMALSMAX = 18;
var TOTALSUPPLYMAX = new BigNumber("1").shift(14); // 100 trillion
var DEPLOYMENTFEEMAX = new BigNumber("100");

var DEFAULTDECIMALS = 18;
var DEFAULTTOTALSUPPLY = new BigNumber("1");

var SYMBOLNOTE = "A short uppercase character string like 'RAMEN'. Max length " + SYMBOLMAXLENGTH + ". Ideally 3 or less characters";
var NAMENOTE = "A mixed case character string like 'Ramen Grade A'. Max length " + NAMEMAXLENGTH;
var DECIMALSNOTE = "A number between 0 and " + DECIMALSMAX + ", inclusive";
var TOTALSUPPLYNOTE = "A number > 0 (to decimal places above) and <= " + TOTALSUPPLYMAX;
var DEPLOYMENTFEENOTE = "Minimum deployment fee ";

var lastNetworkId = -123;
var lastNumberOfChildren = new BigNumber(-123);
var LOOPPERIOD = 10000;
var loopCounter = 0;
var connectionOk = false;
var currentBalance;
var currentMinimumFee;


// ----------------------------------------------------------------------------
// Convenience function
// ----------------------------------------------------------------------------
const promisify = (inner) =>
  new Promise((resolve, reject) =>
    inner((err, res) => {
      if (err) {
        reject(err);
      } else {
        resolve(res);
      }
    })
  );


// ----------------------------------------------------------------------------
// Try to establish a web3 connection
// ----------------------------------------------------------------------------
async function establishConnection() {
  console.log(loopCounter + " [establishConnection] connectionOk: " + connectionOk);

  // Modern dapp browsers...
  if (window.ethereum) {
    window.web3 = new Web3(ethereum);
    try {
      // Request account access if needed
      await ethereum.enable();
      console.log(loopCounter + " [establishConnection] await ethereum.enable() completed");
      // Accounts now exposed
      connectionOk = true;
    } catch (error) {
      // User denied account access...
    }
  // Legacy dapp browsers...
  } else if (window.web3) {
    try {
      window.web3 = new Web3(web3.currentProvider);
      // Acccounts always exposed
      console.log(loopCounter + " [establishConnection] Legacy dapp browsers completed");
      connectionOk = true;
    } catch (error) {
    }
  // Non-dapp browsers...
  } else {
    try {
      window.web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
      console.log(loopCounter + " [establishConnection] Web3 connection");
      connectionOk = true;
    } catch (error) {
    }
  }
}


// ----------------------------------------------------------------------------
// Main process loop, using load to call initially, then setTimeout to trigger
// ----------------------------------------------------------------------------
async function processLoop(loadFromUrl) {
  console.log(loopCounter + " [processLoop] connectionOk: " + connectionOk);
  if (!connectionOk) {
    console.log(loopCounter + " [processLoop] calling establishConnection");
    await establishConnection();
    console.log(loopCounter + " [processLoop] called establishConnection");
  }
  if (connectionOk) {
    try {
      process(loadFromUrl);
    } catch (error) {
      console.log(loopCounter + " [processLoop] connectionOk: " + connectionOk + " - process() error " + error);
    }
  } else {
    console.log(loopCounter + " [processLoop] connectionOk: " + connectionOk + " - Skipping process()");
  }
  loopCounter = parseInt(loopCounter) + 1;
  setTimeout(function() { processLoop(false) }, loadFromUrl ? 1000 : LOOPPERIOD);
}
window.addEventListener('load', async () => {
  console.log(loopCounter + " [load]");
  processLoop(true);
});


// ----------------------------------------------------------------------------
// Get input data from the web page and do some basic checking
// ----------------------------------------------------------------------------
function getInputData() {
  var data = {
    "inputFilled": true,
    "inputError": false,
    "symbol": "",
    "symbolError": false,
    "name": "",
    "nameError": false,
    "decimals": "",
    "decimalsValue": 0,
    "decimalsError": false,
    "totalSupply": "",
    "totalSupplyValue": 0,
    "totalSupplyError": false,
    "deploymentFee": "",
    "deploymentFeeValue": 0,
    "deploymentFeeError": false,
  };

  data.symbol = $('#symbol').val();
  if (data.symbol.length == 0) {
    data.inputFilled = false;
  } else {
    if (data.symbol.length > SYMBOLMAXLENGTH) {
      data.inputError = true;
      data.symbolError = true;
    }
  }

  data.name = $('#name').val();
  if (data.name.length == 0) {
    data.inputFilled = false;
  } else {
    if (data.name.length > NAMEMAXLENGTH) {
      data.inputError = true;
      data.nameError = true;
    }
  }

  data.decimals = $('#decimals').val();
  if (data.decimals.length == 0) {
    data.inputFilled = false;
  } else {
    try {
      data.decimalsValue = parseInt(data.decimals);
      if (isNaN(data.decimalsValue)) {
        throw "nan";
      }
      if (data.decimalsValue < 0 || data.decimalsValue > DECIMALSMAX) {
        throw "out of range";
      }
    } catch (e) {
      console.log(loopCounter + " [getInputData] decimals: " + e);
      data.decimalsValue = DEFAULTDECIMALS;
      data.decimalsError = true;
    }
  }
  if (data.decimalsError) {
    data.inputError = true;
  }

  data.totalSupply = $('#totalSupply').val();
  if (data.totalSupply.length == 0) {
    data.inputFilled = false;
  } else {
    try {
      if (data.inputFilled && !data.decimalsError) {
        data.totalSupplyValue = new BigNumber(data.totalSupply);
        console.log(loopCounter + " [getInputData] totalSupply: " + data.totalSupply);
        console.log(loopCounter + " [getInputData] totalSupplyValue: " + data.totalSupplyValue);
        console.log(loopCounter + " [getInputData] data.totalSupplyValue.shift(data.decimals): " + data.totalSupplyValue.shift(data.decimals));
        console.log(loopCounter + " [getInputData] data.totalSupplyValue.shift(data.decimals).lessThan(1): " + data.totalSupplyValue.shift(data.decimals).lessThan(1));
        console.log(loopCounter + " [getInputData] data.totalSupplyValue > TOTALSUPPLYMAX: " + (data.totalSupplyValue.gt(TOTALSUPPLYMAX)));
        if (isNaN(data.totalSupplyValue)) {
          throw "nan";
        }
        if (data.totalSupplyValue.shift(data.decimals).lessThan(1) || data.totalSupplyValue.gt(TOTALSUPPLYMAX)) {
          throw "out of range";
        }
      }
    } catch (e) {
      console.log(loopCounter + " [getInputData] totalSupply: " + e);
      data.totalSupplyValue = DEFAULTTOTALSUPPLY;
      data.totalSupplyError = true;
    }
  }
  if (data.totalSupplyError) {
    data.inputError = true;
  }

  data.deploymentFee = $('#deploymentFee').val();
  if (data.deploymentFee.length == 0) {
    data.inputFilled = false;
  } else {
    try {
      data.deploymentFeeValue = new BigNumber(data.deploymentFee);
      if (isNaN(data.deploymentFeeValue)) {
        throw "nan";
      }
      if (data.deploymentFee < currentMinimumFee || data.deploymentFee > DEPLOYMENTFEEMAX) {
        throw "out of range";
      }
    } catch (e) {
      console.log(loopCounter + " [getInputData] deploymentFee: " + e);
      data.deploymentFeeValue = currentMinimumFee;
      data.deploymentFeeError = true;
    }
  }
  if (data.deploymentFeeError) {
    data.inputError = true;
  }

  return data;
}


// ----------------------------------------------------------------------------
// Render any input data warnings
// ----------------------------------------------------------------------------
function renderInputData(data) {
  if (data.symbolError) {
    $("#symbolDiv").addClass("has-error");
    $("#symbolNote").html(SYMBOLNOTE);
  } else {
    $("#symbolDiv").removeClass("has-error");
    $("#symbolNote").html("");
  }

  if (data.nameError) {
    $("#nameDiv").addClass("has-error");
    $("#nameNote").html(NAMENOTE);
  } else {
    $("#nameDiv").removeClass("has-error");
    $("#nameNote").html("");
  }

  if (data.decimalsError) {
    $("#decimalsDiv").addClass("has-error");
    $("#decimalsNote").html(DECIMALSNOTE);
  } else {
    $("#decimalsDiv").removeClass("has-error");
    $("#decimalsNote").html("");
  }

  if (data.totalSupplyError) {
    $("#totalSupplyDiv").addClass("has-error");
    $("#totalSupplyNote").html(TOTALSUPPLYNOTE);
  } else {
    $("#totalSupplyDiv").removeClass("has-error");
    $("#totalSupplyNote").html("");
  }

  // Done in the ETH rendering part
  // if (data.deploymentFeeError) {
  //   $("#deploymentFeeDiv").addClass("has-error");
  //   $("#deploymentFeeNote").html(DEPLOYMENTFEENOTE);
  // } else {
  //   $("#deploymentFeeDiv").removeClass("has-error");
  //   $("#deploymentFeeNote").html("");
  // }

  if (data.inputFilled && !data.inputError) {
    $("#deploy").prop("disabled", false);
  } else {
    $("#deploy").prop("disabled", true);
  }
}

var renderingEthData = false;
async function processEth(data, action) {
  var processed = false;
  if (!renderingEthData) {
    renderingEthData = true;

    if (data.inputFilled && !data.inputError) {
      $("#deploy").prop("disabled", false);
    } else {
      $("#deploy").prop("disabled", true);
    }

    var _networkId = promisify(cb => web3.version.getNetwork(cb));
    var _block = promisify(cb => web3.eth.getBlock("latest", cb));
    var _accounts = promisify(cb => web3.eth.getAccounts(cb));
    var networkId = -1;
    var seen = {};
    try {
      networkId = await _networkId;
      var networkChanged = false;
      if (lastNetworkId != networkId) {
        $("#network").html(networkId);
        networkChanged = true;
        lastNetworkId = networkId;
      }
      var network = networks[networkId];
      if (network == null) {
        network = networks[-1];
      }
      if (networkChanged) {
        $("#network").html(network.network);
        $("#faucets").html(network.faucets);
        $("#factoryAddress").html(factoryAddress + ' <a href="'+ network.explorer + 'address/' + factoryAddress + '#code" target="_blank">ðŸ”—</a>');
      }

      var block = await _block;
      var blockNumber = block.number;
      var timestamp = block.timestamp;
      var now = new Date() / 1000;
      var diff = timestamp - now;
      $("#blockNumber").html(blockNumber + ' <a href="'+ network.explorer + 'block/' + blockNumber + '" target="_blank">ðŸ”—</a>');
      $("#blockTime").html(diff.toFixed(2) + " seconds " + new Date(timestamp * 1000).toUTCString());

      var accounts = await _accounts;
      var account = accounts[0];
      $("#account").html(account + ' <a href="' + network.explorer + 'address/' + account + '#code" target="_blank">ðŸ”—</a>');

      var _balance = promisify(cb => web3.eth.getBalance(account, cb));
      var balance = new BigNumber(await _balance).shift(-18);
      currentBalance = balance;
      $("#accountbalance").html(balance.toString() + " ethers");

      var factory = web3.eth.contract(factoryAbi).at(factoryAddress);
      var _minimumFee = promisify(cb => factory.minimumFee(cb));
      var minimumFee = new BigNumber(await _minimumFee).shift(-18);
      currentMinimumFee = minimumFee;
      $("#minimumFee").html(minimumFee.toString() + " ethers");

      console.log(loopCounter + " [processEth] connectionOk: " + connectionOk + " deploymentFee: " + data.deploymentFeeValue + " minimumFee: " + minimumFee);
      if (data.deploymentFee.length > 0 && data.deploymentFeeValue < minimumFee) {
        console.log(loopCounter + " [processEth] connectionOk: " + connectionOk + " deploymentFee: " + data.deploymentFeeValue + " minimumFee: " + minimumFee + " insufficient fee");
        data.deploymentFeeError = true;
      }
      if (data.deploymentFeeError) {
        $("#deploymentFeeDiv").addClass("has-error");
        $("#deploymentFeeNote").html(DEPLOYMENTFEENOTE + minimumFee + " ethers");
      } else {
        $("#deploymentFeeDiv").removeClass("has-error");
        $("#deploymentFeeNote").html("");
      }

      var _numberOfChildren = promisify(cb => factory.numberOfChildren(cb));
      var numberOfChildren = new BigNumber(await _numberOfChildren);
      var factoryUpdated = false;
      if (!lastNumberOfChildren.equals(numberOfChildren)) {
        console.log(loopCounter + " [processEth] " + action + ": lastNumberOfChildren: " + lastNumberOfChildren + ", numberOfChildren: " + numberOfChildren);
        factoryUpdated = true;
        lastNumberOfChildren = numberOfChildren;
      }
      console.log(loopCounter + " [processEth] " + action + ": networkChanged: " + networkChanged + ", factoryUpdated: " + factoryUpdated);
      if (networkChanged || factoryUpdated) {
        var deployedContractsList = $('#deployedContractsList');
        deployedContractsList.empty();
        var child = numberOfChildren - 1;
        while (child >= 0) {
          var _childAddress = promisify(cb => factory.children(child, cb));
          var childAddress = await _childAddress;
          var token = web3.eth.contract(tokenAbi).at(childAddress);
          var _symbol = promisify(cb => token.symbol(cb));
          var _name = promisify(cb => token.name(cb));
          var _decimals = promisify(cb => token.decimals(cb));
          var _totalSupply = promisify(cb => token.totalSupply(cb));
          var symbol = await _symbol;
          var name = await _name;
          var decimals = await _decimals;
          var totalSupply = await _totalSupply;
          if (!(childAddress in seen)) {
            deployedContractsList.append("<li><a href=\"" + network.explorer + "token/" + childAddress + "\">" + symbol + "</a>, " + name + ", " + decimals + ", " + new BigNumber(totalSupply).shift(-decimals) + " @ " + childAddress + " <a href=\""+ network.explorer + "address/" + childAddress + "#code\" target=\"_blank\">ðŸ”—</a></li>");
            seen[childAddress] = true;
          }
          child--;
        }
      }

      if (data.inputFilled && !data.inputError && action == "deployClicked") {
        $("#deploy").prop("disabled", true);
        // $("#deployNote").html('Deploying token contract with deployment fee: ' + data.deploymentFeeValue.shift(-18).value);
        var gas = 1200000;
        console.log("deploy balance: " + JSON.stringify(balance));
        console.log("deploy data.deploymentFee: " + JSON.stringify(data.deploymentFeeValue.shift(-18)));
        console.log("deploy minimumFee: " + JSON.stringify(minimumFee));
        // var status = balance.ge(data.deploymentFee); // && minimumFee.le(data.deploymentFee);
        // var status = minimumFee.le(data.deploymentFee);
        // console.log("deploy status: " + status);
        // balance = new BigNumber(balance);
        // var deploymentFee = new BigNumber(data.deploymentFee);
        // minimumFee = new BigNumber(minimumFee);
        if ((balance >= data.deploymentFeeValue) && (data.deploymentFeeValue >= minimumFee)) {
          console.log("deployTokenContract: symbol: " + data.symbol);
          console.log("deployTokenContract: name: " + data.name);
          console.log("deployTokenContract: decimals: " + data.decimalsValue);
          console.log("deployTokenContract: totalSupply: " + data.totalSupplyValue.shift(data.decimals));
          console.log("deployTokenContract: account: " + account);
          console.log("deployTokenContract: gas: " + gas);
          console.log("deployTokenContract: data.deploymentFee: " + data.deploymentFeeValue);
          console.log("deployTokenContract: executing: factory.deployTokenContract(" + data.symbol + ", " + data.name + ", " + data.decimalsValue + ", " + data.totalSupplyValue.shift(data.decimals).toString() + ", {from: " + account + ", gas: " + gas + ", value: " + data.deploymentFeeValue.shift(18).toString() + "})");
          // function deployTokenContract(string memory symbol, string memory name, uint8 decimals, uint totalSupply) public payable returns (FixedSupplyToken token);
          factory.deployTokenContract(data.symbol, data.name, data.decimals, data.totalSupplyValue.shift(data.decimalsValue).toString(), {from: account, gas: gas, value: data.deploymentFeeValue.shift(18).toString()}, function(error, tx) {
            if (!error) {
              $("#deployNote").html('Deployed ' + tx + ' <a href="' + network.explorer + 'tx/' + tx + '" target="_blank">ðŸ”—</a>');
            } else {
              console.log("deployTokenContract error: " + error);
              $("#deployNote").html('Deployment ' + error);
              $("#deploy").prop("disabled", true);
            }
          });
        } else {
          $("#deployNote").html('Insufficient funds in your account ' + balance + ' ethers to pay the minimum fee of ' + minimumFee + " ethers");
        }
      }

    } catch (error) {
      var errorString = "";
      for (var key in error) {
        errorString += "{" + key + ": " + error[key] + "}";
      }
      $("#network").html(errorString);
    }
    processed = true;
    renderingEthData = false;
  }
  return processed;
}


// ----------------------------------------------------------------------------
// Main process. Connection should already be established
// Throw an error if there is a problem
// ----------------------------------------------------------------------------
function process() {
  console.log(loopCounter + " [process]");
  var data = getInputData();
  renderInputData(data);
  console.log(loopCounter + " [process] data: " + JSON.stringify(data));
  processEth(data, 'refresh');
}


// ----------------------------------------------------------------------------
// Functions
// ----------------------------------------------------------------------------
var functionCounter = 0;

async function executeFunction(action) {
  console.log(functionCounter + " [executeFunction] connectionOk: " + connectionOk);
  if (!connectionOk) {
    console.log(loopCounter + " [executeFunction] calling establishConnection");
    await establishConnection();
    console.log(loopCounter + " [executeFunction] called establishConnection");
  }
  if (connectionOk) {
    try {
      var data = getInputData(false);
      renderInputData(data);
      // Retry in case we are in a ETH refresh process
      while (!processEth(data, action)) {
        ;
      }
    } catch (error) {
      console.log(functionCounter + " [executeFunction] connectionOk: " + connectionOk + " - process() error " + error);
    }
  } else {
    console.log(functionCounter + " [executeFunction] connectionOk: " + connectionOk + " - Skipping processing");
  }
  functionCounter = parseInt(functionCounter) + 1;
}

$('#deploy').on('click', function (e) {
  executeFunction('deployClicked');
})
$('#symbol').on('change', function (e) {
  executeFunction('symbolChanged');
})
$('#name').on('change', function (e) {
  executeFunction('nameChanged');
})
$('#decimals').on('change', function (e) {
  executeFunction('decimalsChanged');
})
$('#totalSupply').on('change', function (e) {
  executeFunction('totalSupplyChanged');
})
$('#deploymentFee').on('change', function (e) {
  executeFunction('deploymentFeeChanged');
})

</script>
  </body>
</html>
